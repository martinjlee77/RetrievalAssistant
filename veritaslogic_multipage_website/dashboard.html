<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - VeritasLogic.ai</title>
    <!-- Force cache refresh -->
    <meta name="description" content="Manage your VeritasLogic account, track your usage, and access your ASC analysis tools.">
    <link rel="stylesheet" href="styles.css?v=2025090702">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="/">VeritasLogic.ai</a>
            </div>
            <div class="nav-links">
                <a href="https://a45dfa8e-cff4-4d5e-842f-dc8d14b3b2d2-00-3khkzanf4tmm3.picard.replit.dev:3002" target="_blank">Analysis Platform</a>
                <a href="/">Home</a>
                <button onclick="logout()" class="btn btn-secondary btn-sm">Sign Out</button>
            </div>
        </div>
    </nav>

    <div class="dashboard-container" id="dashboardContent" style="padding-top: 100px;">
        <!-- Loading state -->
        <div class="loading" id="loadingState">
            <p>Loading your dashboard...</p>
        </div>

        <!-- Inline Login Form -->
        <div id="loginSection" style="display: none;">
            <div class="login-form-container">
                <div class="login-form">
                    <h2>üîê Sign In to Your Dashboard</h2>
                    <p>Enter your registered business email address to access your account.</p>
                    
                    <div id="loginMessage"></div>
                    
                    <form id="dashboardLoginForm">
                        <div class="form-group">
                            <label for="loginEmail">Business Email Address</label>
                            <input type="email" id="loginEmail" name="email" placeholder="your.email@company.com" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="loginButton">
                            Sign In
                        </button>
                    </form>
                    
                    <div class="login-links">
                        <p>Don't have an account? <a href="signup.html">Create account with instant activation</a></p>
                        <p><a href="index.html">‚Üê Back to homepage</a></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main dashboard content -->
        <div id="mainContent" style="display: none;">
            <div class="dashboard-header">
                <div class="welcome-section">
                    <h1>Welcome back, <span id="userName">User</span>!</h1>
                    <p id="memberSince">Member since</p>
                </div>
                <div class="header-actions">
                    <a href="https://a45dfa8e-cff4-4d5e-842f-dc8d14b3b2d2-00-3khkzanf4tmm3.picard.replit.dev:3002" class="btn btn-primary" target="_blank">Launch Analysis Tool</a>
                    <button onclick="logout()" class="btn btn-secondary">Sign Out</button>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <!-- Credits & Usage Overview -->
                <div class="card">
                    <h2>üí≥ Account Overview</h2>
                    
                    <div id="freeAnalysesSection" class="free-analyses">
                        <div class="number" id="freeAnalysesCount">3</div>
                        <div class="label">Free Analyses Remaining</div>
                    </div>
                    
                    <div class="credits-display" id="creditsSection" style="display: none;">
                        <div class="number" id="creditsBalance">$0</div>
                        <div class="label">Paid Credits Available</div>
                    </div>
                    
                    <div class="usage-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalAnalyses">0</div>
                            <div class="stat-label">Total Analyses</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="thisMonth">0</div>
                            <div class="stat-label">This Month</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalSpent">$0</div>
                            <div class="stat-label">Total Spent</div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Analyses -->
                <div class="card">
                    <h2>üìä Recent Analyses</h2>
                    <div id="recentAnalysesList" class="recent-analyses">
                        <div class="empty-state">
                            <div>üìÑ</div>
                            <p>No analyses yet. Ready to get started?</p>
                            <a href="https://a45dfa8e-cff4-4d5e-842f-dc8d14b3b2d2-00-3khkzanf4tmm3.picard.replit.dev:3002" class="btn btn-primary" target="_blank">Start Your First Analysis</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Profile Section -->
            <div class="card profile-section">
                <h2>üë§ Profile Information</h2>
                <div class="profile-fields">
                    <div class="profile-field">
                        <span class="field-label">Email:</span>
                        <span class="field-value" id="userEmail">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="field-label">Company:</span>
                        <span class="field-value" id="userCompany">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="field-label">Member Since:</span>
                        <span class="field-value" id="memberSinceDate">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="field-label">Account Status:</span>
                        <span class="field-value" id="accountStatus">Active</span>
                    </div>
                </div>
                
                <!-- Change Password Section -->
                <div class="change-password-section">
                    <h3>üîê Change Password</h3>
                    <div id="changePasswordMessage"></div>
                    <form id="changePasswordForm" style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" name="currentPassword" placeholder="Enter current password (legacy users can leave blank)">
                            <small>Legacy users (email-only login) can leave this field blank</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" name="newPassword" required placeholder="Enter your new password">
                            <div class="password-requirements">
                                <small>Password must contain at least:</small>
                                <ul>
                                    <li id="req-length">8 characters</li>
                                    <li id="req-uppercase">One uppercase letter</li>
                                    <li id="req-lowercase">One lowercase letter</li>
                                    <li id="req-number">One number</li>
                                    <li id="req-special">One special character</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmNewPassword">Confirm New Password</label>
                            <input type="password" id="confirmNewPassword" name="confirmNewPassword" required placeholder="Confirm your new password">
                            <div id="password-match" class="password-feedback"></div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="changePasswordButton">
                            Update Password
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dashboard initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        async function initializeDashboard() {
            console.log('Dashboard initializing...');
            const token = localStorage.getItem('authToken');
            console.log('Token found:', token ? 'Yes' : 'No');
            
            if (!token || token === 'null' || token === 'undefined') {
                // No valid token - show login form immediately
                console.log('No valid token, showing login form');
                showLoginForm();
                return;
            }
            
            // Have valid token - try to fetch user data
            console.log('Valid token found, fetching user data...');
            try {
                const response = await fetch('/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const profileData = await response.json();
                    console.log('Profile data received:', profileData);
                    showDashboard(profileData.user);
                } else {
                    // Token invalid - clear and show login
                    console.log('Token invalid, clearing and showing login');
                    localStorage.removeItem('authToken');
                    showLoginForm();
                }
            } catch (error) {
                console.error('Network error:', error);
                // Only show network error if we actually had a token (real network issue)
                console.log('Network error occurred, showing network error');
                showNetworkError();
            }
        }

        function showLoginForm() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
        }

        function showDashboard(userData) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            populateDashboard(userData);
        }

        function showNetworkError() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginSection').style.display = 'none';
            
            const errorContainer = document.createElement('div');
            errorContainer.className = 'network-error-container';
            errorContainer.innerHTML = `
                <div class="network-error">
                    <h2>‚ö†Ô∏è Connection Error</h2>
                    <p>Unable to connect to the server. Please check your internet connection and try again.</p>
                    <button onclick="retryConnection()" class="btn btn-primary">Try Again</button>
                </div>
            `;
            document.getElementById('dashboardContent').appendChild(errorContainer);
        }

        function retryConnection() {
            const errorContainers = document.querySelectorAll('.network-error-container');
            errorContainers.forEach(container => container.remove());
            document.getElementById('loadingState').style.display = 'flex';
            initializeDashboard();
        }

        // Handle login form submission
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('dashboardLoginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const loginButton = document.getElementById('loginButton');
            const messageContainer = document.getElementById('loginMessage');
            
            if (!email) {
                showLoginMessage('Please enter your email address', 'error');
                return;
            }
            
            // Show loading state
            loginButton.disabled = true;
            loginButton.textContent = 'Signing In...';
            messageContainer.innerHTML = '';
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Store auth token
                    localStorage.setItem('authToken', data.token);
                    
                    // Show success message briefly
                    showLoginMessage('Login successful! Loading dashboard...', 'success');
                    
                    // Load dashboard after short delay
                    setTimeout(() => {
                        showDashboard(data.user);
                    }, 1000);
                    
                } else {
                    const errorData = await response.json();
                    showLoginMessage(errorData.error || 'Login failed. Please try again.', 'error');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showLoginMessage('Network error. Please check your connection and try again.', 'error');
            } finally {
                // Reset loading state
                loginButton.disabled = false;
                loginButton.textContent = 'Sign In';
            }
        }

        function showLoginMessage(message, type) {
            const container = document.getElementById('loginMessage');
            container.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        function populateDashboard(userData) {
            console.log('Populating dashboard with user data:', userData);
            console.log('Email field:', userData.email);
            console.log('Company field:', userData.company_name);
            console.log('All user data keys:', Object.keys(userData));
            
            // Update welcome section (backend returns snake_case fields)
            document.getElementById('userName').textContent = userData.first_name || 'User';
            document.getElementById('memberSince').textContent = `Member since ${new Date(userData.member_since || Date.now()).toLocaleDateString()}`;
            
            // Update profile information
            document.getElementById('userEmail').textContent = userData.email || '-';
            document.getElementById('userCompany').textContent = userData.company_name || '-';
            document.getElementById('memberSinceDate').textContent = new Date(userData.member_since || Date.now()).toLocaleDateString() || '-';
            
            // Update credits and usage (backend returns snake_case fields)
            const freeAnalyses = userData.free_analyses_remaining || 3;
            const paidCredits = userData.credits_balance || 0;
            
            document.getElementById('freeAnalysesCount').textContent = freeAnalyses;
            
            if (paidCredits > 0) {
                document.getElementById('creditsSection').style.display = 'block';
                document.getElementById('creditsBalance').textContent = `$${paidCredits.toFixed(2)}`;
            }
            
            // Update usage statistics
            document.getElementById('totalAnalyses').textContent = userData.total_analyses || userData.totalAnalyses || 0;
            document.getElementById('thisMonth').textContent = userData.analyses_this_month || userData.analysesThisMonth || 0;
            document.getElementById('totalSpent').textContent = `$${(userData.total_spent || userData.totalSpent || 0).toFixed(2)}`;
            
            // Load recent analyses
            loadRecentAnalyses(userData.recentAnalyses || []);
        }

        function loadRecentAnalyses(analyses) {
            const container = document.getElementById('recentAnalysesList');
            
            if (analyses.length === 0) {
                // Keep the empty state
                return;
            }
            
            container.innerHTML = '';
            analyses.forEach(analysis => {
                const item = document.createElement('div');
                item.className = 'analysis-item';
                item.innerHTML = `
                    <div class="analysis-details">
                        <h4>${analysis.title}</h4>
                        <p>${analysis.asc_standard} ‚Ä¢ ${new Date(analysis.created_at).toLocaleDateString()} ‚Ä¢ $${analysis.cost}</p>
                    </div>
                    <a href="${analysis.download_url}" class="btn btn-secondary" target="_blank">Download</a>
                `;
                container.appendChild(item);
            });
        }

        function logout() {
            localStorage.removeItem('authToken');
            showLoginForm();
        }
        
        // Password strength validation function
        function validatePasswordStrength(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };
            
            // Update visual indicators
            const lengthEl = document.getElementById('req-length');
            const uppercaseEl = document.getElementById('req-uppercase');
            const lowercaseEl = document.getElementById('req-lowercase');
            const numberEl = document.getElementById('req-number');
            const specialEl = document.getElementById('req-special');
            
            if (lengthEl) lengthEl.className = requirements.length ? 'valid' : '';
            if (uppercaseEl) uppercaseEl.className = requirements.uppercase ? 'valid' : '';
            if (lowercaseEl) lowercaseEl.className = requirements.lowercase ? 'valid' : '';
            if (numberEl) numberEl.className = requirements.number ? 'valid' : '';
            if (specialEl) specialEl.className = requirements.special ? 'valid' : '';
            
            return Object.values(requirements).every(req => req);
        }
        
        function showChangePasswordMessage(message, type) {
            const container = document.getElementById('changePasswordMessage');
            if (container) {
                container.innerHTML = `<div class="${type}-message">${message}</div>`;
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // Initialize change password functionality
        setTimeout(() => {
            // Real-time password validation
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', function(e) {
                    validatePasswordStrength(e.target.value);
                });
            }
            
            // Password confirmation validation
            const confirmPasswordInput = document.getElementById('confirmNewPassword');
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', function(e) {
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = e.target.value;
                    const feedback = document.getElementById('password-match');
                    
                    if (!feedback) return;
                    
                    if (confirmPassword === '') {
                        feedback.textContent = '';
                        feedback.className = 'password-feedback';
                    } else if (newPassword === confirmPassword) {
                        feedback.textContent = '‚úì Passwords match';
                        feedback.className = 'password-feedback valid';
                    } else {
                        feedback.textContent = '‚úó Passwords do not match';
                        feedback.className = 'password-feedback invalid';
                    }
                });
            }
            
            // Change password form submission
            const changePasswordForm = document.getElementById('changePasswordForm');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                    const submitButton = document.getElementById('changePasswordButton');
                    
                    // Validate passwords match
                    if (newPassword !== confirmNewPassword) {
                        showChangePasswordMessage('Passwords do not match', 'error');
                        return;
                    }
                    
                    // Validate password strength
                    if (!validatePasswordStrength(newPassword)) {
                        showChangePasswordMessage('Password does not meet the requirements', 'error');
                        return;
                    }
                    
                    // Show loading state
                    submitButton.disabled = true;
                    submitButton.textContent = 'Updating Password...';
                    
                    try {
                        const token = localStorage.getItem('authToken');
                        const response = await fetch('/api/change-password', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                current_password: currentPassword,
                                new_password: newPassword
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showChangePasswordMessage('Password has been updated successfully!', 'success');
                            // Clear form
                            changePasswordForm.reset();
                            // Clear password match feedback
                            const feedback = document.getElementById('password-match');
                            if (feedback) {
                                feedback.textContent = '';
                                feedback.className = 'password-feedback';
                            }
                        } else {
                            showChangePasswordMessage(result.error || 'Password change failed. Please try again.', 'error');
                        }
                        
                    } catch (error) {
                        console.error('Change password error:', error);
                        showChangePasswordMessage('Network error. Please check your connection and try again.', 'error');
                    } finally {
                        // Reset loading state
                        submitButton.disabled = false;
                        submitButton.textContent = 'Update Password';
                    }
                });
            }
        }, 100);
    </script>
</body>
</html>