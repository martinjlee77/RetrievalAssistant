<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - VeritasLogic.ai</title>
    
    <!-- SEO and Security -->
    <meta name="description" content="Manage your VeritasLogic account, track your usage, and access your ASC analysis tools.">
    <meta name="robots" content="noindex, nofollow">
    <link rel="canonical" href="https://veritaslogic.ai/dashboard.html">
    <meta name="referrer" content="no-referrer">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles.css?v=2025090702">
    <!-- Stripe JavaScript -->
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo">VeritasLogic.ai</a>
            <ul class="nav-links">
                <li><a href="/analysis" target="_blank">Analysis Platform</a></li>
                <li><a href="/">Home</a></li>
                <li><button onclick="logout()" class="btn btn-secondary btn-nav">Log Out</button></li>
            </ul>
        </div>
    </nav>

    <div class="dashboard-container" id="dashboardContent" style="padding-top: 100px;">
        <!-- Dashboard Sidebar -->
        <div class="dashboard-sidebar" id="dashboardSidebar" style="display: none;">
            <div class="sidebar-header">
                <h3>Dashboard</h3>
            </div>
            <nav class="sidebar-nav">
                <a href="#overview" class="nav-item active" onclick="showSection('overview')">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">Overview</span>
                </a>
                <a href="#credits" class="nav-item" onclick="showSection('credits')">
                    <span class="nav-icon">üí≥</span>
                    <span class="nav-text">Credits</span>
                </a>
                <a href="#profile" class="nav-item" onclick="showSection('profile')">
                    <span class="nav-icon">üë§</span>
                    <span class="nav-text">Profile</span>
                </a>
                <a href="#history" class="nav-item" onclick="showSection('history')">
                    <span class="nav-icon">üìà</span>
                    <span class="nav-text">History</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <a href="/analysis" class="btn btn-primary" target="_blank">Launch Analysis</a>
            </div>
        </div>

        <!-- Dashboard Main Content -->
        <div class="dashboard-main" id="dashboardMain" style="display: none;">
        <!-- Loading state -->
        <div class="loading" id="loadingState">
            <p>Loading your dashboard...</p>
        </div>

        <!-- Inline Login Form -->
        <div id="loginSection" style="display: none;">
            <div class="login-form-container">
                <div class="login-form">
                    <h2>üîê Sign In to Your Dashboard</h2>
                    <p>Enter your business email and password to access your account.</p>
                    
                    <div id="loginMessage" aria-live="polite"></div>
                    
                    <form id="dashboardLoginForm">
                        <div class="form-group">
                            <label for="loginEmail">Business Email Address</label>
                            <input type="email" id="loginEmail" name="email" placeholder="your.email@company.com" required autocomplete="email">
                        </div>
                        
                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <input type="password" id="loginPassword" name="password" required autocomplete="current-password">
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="loginButton">
                            Sign In
                        </button>
                    </form>
                    
                    <div class="login-links">
                        <p>Don't have an account? <a href="signup.html">Create account with instant activation</a></p>
                        <p><a href="index.html">‚Üê Back to homepage</a></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main dashboard content -->
        <div id="mainContent" style="display: none;">
            <div class="dashboard-header">
                <div class="welcome-section">
                    <h1>Welcome back, <span id="userName">User</span>!</h1>
                    <p id="memberSince">Member since</p>
                </div>
            </div>

            <!-- Overview Section -->
            <div id="overviewSection" class="dashboard-section active">
            
                <div class="dashboard-grid">
                    <!-- Account Balance Card -->
                    <div class="card balance-card">
                        <h2>üí≥ Account Balance</h2>
                        
                        <div class="credits-display" id="creditsDisplay">
                            <div class="number" id="creditsBalance">$0</div>
                            <div class="label">Account Credits Available</div>
                            <small class="credits-expiry">Credits expire 12 months from purchase.</small>
                        </div>
                        
                        <button onclick="showSection('credits')" class="btn btn-primary" style="margin-top: 20px; width: 100%;">
                            üí≥ Add Credits
                        </button>
                    </div>
                    
                    <!-- Usage Stats Card -->
                    <div class="card stats-card">
                        <h2>üìà Usage Statistics</h2>
                        <div class="usage-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="totalAnalyses">0</div>
                                <div class="stat-label">Total Analyses</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="thisMonth">0</div>
                                <div class="stat-label">This Month</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalSpent">$0</div>
                                <div class="stat-label">Total Spent</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions Card -->
                    <div class="card actions-card">
                        <h2>üöÄ Quick Actions</h2>
                        <div class="action-buttons">
                            <a href="/analysis" class="btn btn-secondary" target="_blank">Launch Analysis Tool</a>
                            <button onclick="showSection('credits')" class="btn btn-secondary">Add Credits</button>
                            <button onclick="showSection('history')" class="btn btn-secondary">View History</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Credits Section -->
            <div id="creditsSection" class="dashboard-section">
                <div class="section-header">
                    <h2>üí≥ Manage Credits</h2>
                    <p>Add credits to your account to continue using our analysis platform.</p>
                    <p class="credits-policy"><strong>Credits expire 12 months from purchase</strong> and are automatically deducted per analysis based on document size. Payments are processed securely via Stripe.</p>
                </div>
            
                <div class="card credit-purchase-card">
                    <h3>üí≥ Credit Packages</h3>
                    <div class="credit-packages" id="creditPackages">
                        <!-- Credit packages will be loaded here -->
                        <div class="loading-packages">Loading packages...</div>
                    </div>
                    
                    <h3>‚úèÔ∏è Custom Amount</h3>
                    <div class="custom-amount-section">
                        <div class="custom-amount-input">
                            <label for="customAmount">Enter amount ($95 - $3,000):</label>
                            <div class="amount-input-group">
                                <span class="currency-symbol">$</span>
                                <input type="number" id="customAmount" min="95" max="3000" step="1" placeholder="500">
                                <button onclick="selectCustomAmount()" class="btn btn-secondary">Select</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="payment-form-container" id="paymentFormContainer" style="display: none;">
                        <h3>Payment Details</h3>
                        <div class="selected-package" id="selectedPackageDisplay"></div>
                        
                        <form id="payment-form">
                            <div id="card-element">
                                <!-- Stripe card element will be inserted here -->
                            </div>
                            <div id="card-errors" role="alert"></div>
                            
                            <button type="submit" id="submit-payment" class="btn btn-primary payment-btn">
                                <span id="button-text">Complete Payment</span>
                            </button>
                        </form>
                        
                        <button onclick="cancelPayment()" class="btn btn-secondary">Cancel</button>
                    </div>
                    
                    <div id="payment-messages" aria-live="polite"></div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profileSection" class="dashboard-section">
                <div class="section-header">
                    <h2>üë§ Profile Information</h2>
                    <p>Manage your account settings and security.</p>
                </div>
            
                <div class="profile-grid">
                    <div class="card profile-info-card">
                        <h3>üìß Account Information</h3>
                        <div class="profile-fields">
                            <div class="profile-field">
                                <span class="field-label">First Name:</span>
                                <span class="field-value" id="userFirstName">-</span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Last Name:</span>
                                <span class="field-value" id="userLastName">-</span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Email:</span>
                                <span class="field-value" id="userEmail">-</span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Company:</span>
                                <span class="field-value" id="userCompany">-</span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Member Since:</span>
                                <span class="field-value" id="memberSinceDate">-</span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Account Status:</span>
                                <span class="field-value" id="accountStatus">Active</span>
                            </div>
                        </div>
                        
                        <!-- Edit Profile Section -->
                        <div class="edit-profile-section">
                            <h4>‚úèÔ∏è Edit Name</h4>
                            <div id="editProfileMessage" aria-live="polite"></div>
                            <form id="editProfileForm" style="margin-top: 15px;" onsubmit="submitProfileUpdate(event)">
                                <div class="form-group">
                                    <label for="editFirstName">First Name</label>
                                    <input type="text" id="editFirstName" name="firstName" required placeholder="Enter your first name" autocomplete="given-name">
                                </div>
                                
                                <div class="form-group">
                                    <label for="editLastName">Last Name</label>
                                    <input type="text" id="editLastName" name="lastName" required placeholder="Enter your last name" autocomplete="family-name">
                                </div>
                                
                                <button type="submit" class="btn btn-primary" id="updateProfileButton">
                                    Update Name
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="card password-card">
                
                        <h3>üîê Change Password</h3>
                    <div id="changePasswordMessage" aria-live="polite"></div>
                    <form id="changePasswordForm" style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" name="currentPassword" required placeholder="Enter your current password" autocomplete="current-password">
                        </div>
                        
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" name="newPassword" required placeholder="Enter your new password" autocomplete="new-password">
                            <div class="password-requirements">
                                <small>Password must contain at least:</small>
                                <ul>
                                    <li id="req-length">8 characters</li>
                                    <li id="req-uppercase">One uppercase letter</li>
                                    <li id="req-lowercase">One lowercase letter</li>
                                    <li id="req-number">One number</li>
                                    <li id="req-special">One special character</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmNewPassword">Confirm New Password</label>
                            <input type="password" id="confirmNewPassword" name="confirmNewPassword" required placeholder="Confirm your new password" autocomplete="new-password">
                            <div id="password-match" class="password-feedback"></div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="changePasswordButton">
                            Update Password
                        </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="historySection" class="dashboard-section">
                <div class="section-header">
                    <h2>üìà Analysis History</h2>
                    <p>View your recent analyses and download reports.</p>
                </div>
                
                <div class="card history-card">
                    <div id="recentAnalysesList" class="recent-analyses">
                        <div class="empty-state">
                            <div>üìÑ</div>
                            <p>No analyses yet. Ready to get started?</p>
                            <a href="/analysis" class="btn btn-primary" target="_blank">Start Your First Analysis</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        // Dashboard initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        async function initializeDashboard() {
            console.log('Dashboard initializing...');
            const token = localStorage.getItem('authToken');
            console.log('Token found:', token ? 'Yes' : 'No');
            
            if (!token || token === 'null' || token === 'undefined') {
                // No valid token - show login form immediately
                console.log('No valid token, showing login form');
                showLoginForm();
                return;
            }
            
            // Have valid token - try to fetch user data
            console.log('Valid token found, fetching user data...');
            try {
                const response = await fetch('/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const profileData = await response.json();
                    console.log('Profile data received:', profileData);
                    showDashboard(profileData.user);
                } else {
                    // Token invalid - clear and show login
                    console.log('Token invalid, clearing and showing login');
                    localStorage.removeItem('authToken');
                    showLoginForm();
                }
            } catch (error) {
                console.error('Network error:', error);
                // Only show network error if we actually had a token (real network issue)
                console.log('Network error occurred, showing network error');
                showNetworkError();
            }
        }

        function showLoginForm() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
        }

        function showDashboard(userData) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('dashboardSidebar').style.display = 'block';
            document.getElementById('dashboardMain').style.display = 'block';
            populateDashboard(userData);
            
            // Check for hash in URL to show specific section
            const hash = window.location.hash.replace('#', '');
            if (hash && ['overview', 'credits', 'profile', 'history'].includes(hash)) {
                showSection(hash);
            } else {
                showSection('overview');
            }
        }

        function showNetworkError() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginSection').style.display = 'none';
            
            const errorContainer = document.createElement('div');
            errorContainer.className = 'network-error-container';
            errorContainer.innerHTML = `
                <div class="network-error">
                    <h2>‚ö†Ô∏è Connection Error</h2>
                    <p>Unable to connect to the server. Please check your internet connection and try again.</p>
                    <button onclick="retryConnection()" class="btn btn-primary">Try Again</button>
                </div>
            `;
            document.getElementById('dashboardContent').appendChild(errorContainer);
        }

        function retryConnection() {
            const errorContainers = document.querySelectorAll('.network-error-container');
            errorContainers.forEach(container => container.remove());
            document.getElementById('loadingState').style.display = 'flex';
            initializeDashboard();
        }

        // Handle login form submission
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('dashboardLoginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginButton = document.getElementById('loginButton');
            const messageContainer = document.getElementById('loginMessage');
            
            if (!email) {
                showLoginMessage('Please enter your email address', 'error');
                return;
            }
            
            if (!password) {
                showLoginMessage('Please enter your password', 'error');
                return;
            }
            
            // Show loading state
            loginButton.disabled = true;
            loginButton.textContent = 'Signing In...';
            messageContainer.innerHTML = '';
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email, password: password })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Store auth token
                    localStorage.setItem('authToken', data.token);
                    
                    // Show success message briefly
                    showLoginMessage('Login successful! Loading dashboard...', 'success');
                    
                    // Load dashboard after short delay
                    setTimeout(() => {
                        showDashboard(data.user);
                    }, 1000);
                    
                } else {
                    const errorData = await response.json();
                    showLoginMessage(errorData.error || 'Login failed. Please try again.', 'error');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showLoginMessage('Network error. Please check your connection and try again.', 'error');
            } finally {
                // Reset loading state
                loginButton.disabled = false;
                loginButton.textContent = 'Sign In';
            }
        }

        function showLoginMessage(message, type) {
            const container = document.getElementById('loginMessage');
            container.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        async function populateDashboard(userData) {
            console.log('Populating dashboard with user data:', userData);
            
            // Update welcome section (backend returns snake_case fields)
            document.getElementById('userName').textContent = userData.first_name || 'User';
            document.getElementById('memberSince').textContent = userData.member_since ? `Member since ${new Date(userData.member_since).toLocaleDateString()}` : 'Member since ‚Äî';
            
            // Update profile information
            document.getElementById('userFirstName').textContent = userData.first_name || '-';
            document.getElementById('userLastName').textContent = userData.last_name || '-';
            document.getElementById('userEmail').textContent = userData.email || '-';
            document.getElementById('userCompany').textContent = userData.company_name || '-';
            document.getElementById('memberSinceDate').textContent = userData.member_since ? new Date(userData.member_since).toLocaleDateString() : '‚Äî';
            
            // Pre-fill edit profile form
            document.getElementById('editFirstName').value = userData.first_name || '';
            document.getElementById('editLastName').value = userData.last_name || '';
            
            // Update credits display
            const paidCredits = parseFloat(userData.credits_balance || 0);
            document.getElementById('creditsBalance').textContent = `$${paidCredits.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            // Load usage statistics
            await loadUsageStatistics();
            
            // Load recent analyses
            await loadAnalysisHistory();
            
            // Load credit packages for Credits section
            console.log('Initial load of credit packages...');
            await loadCreditPackages();
            
            // Force fallback packages as backup
            setTimeout(() => {
                const container = document.getElementById('creditPackages');
                if (container && container.innerHTML.trim() === '') {
                    console.log('Container still empty, forcing fallback packages');
                    showFallbackPackages();
                }
            }, 2000);
        }

        async function loadUsageStatistics() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/user/usage-stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Update usage statistics
                        document.getElementById('totalAnalyses').textContent = data.stats.total_analyses;
                        document.getElementById('thisMonth').textContent = data.stats.analyses_this_month;
                        document.getElementById('totalSpent').textContent = `$${Math.abs(data.stats.total_spent).toFixed(2)}`;
                    }
                } else {
                    console.error('Failed to load usage statistics');
                }
            } catch (error) {
                console.error('Error loading usage statistics:', error);
            }
        }

        async function loadAnalysisHistory() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/user/analysis-history', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        loadRecentAnalyses(data.analyses);
                    }
                } else {
                    console.error('Failed to load analysis history');
                }
            } catch (error) {
                console.error('Error loading analysis history:', error);
            }
        }

        async function loadCreditPackages() {
            console.log('Loading credit packages...');
            
            try {
                const response = await fetch('/api/credit-packages');
                const { packages } = await response.json();
                
                const container = document.getElementById('creditPackages');
                container.innerHTML = '';
                
                packages.forEach(pkg => {
                    const packageEl = document.createElement('div');
                    packageEl.className = 'credit-package';
                    packageEl.onclick = () => selectPackage(pkg.amount);
                    
                    packageEl.innerHTML = `
                        <div class="package-amount">$${pkg.amount.toLocaleString()}</div>
                        <div class="package-description">Add $${pkg.amount.toLocaleString()} Credits</div>
                    `;
                    container.appendChild(packageEl);
                });
                
            } catch (error) {
                console.error('Failed to load credit packages:', error);
                // Show fallback packages
                showFallbackPackages();
            }
        }
        
        function showFallbackPackages() {
            const container = document.getElementById('creditPackages');
            if (!container) return;
            
            container.innerHTML = '';
            
            const packages = [
                {amount: 500, display: 'Professional Package'},
                {amount: 1000, display: 'Enterprise Package'},
                {amount: 2000, display: 'Premium Package'}
            ];
            
            packages.forEach(pkg => {
                const packageEl = document.createElement('div');
                packageEl.className = 'credit-package';
                packageEl.onclick = () => selectPackage(pkg.amount);
                
                packageEl.innerHTML = `
                    <div class="package-amount">$${pkg.amount.toLocaleString()}</div>
                    <div class="package-description">Add $${pkg.amount.toLocaleString()} Credits</div>
                `;
                container.appendChild(packageEl);
            });
            
            // Remove hardcoded packages - use dynamic loading above
        }

        function loadRecentAnalyses(analyses) {
            const container = document.getElementById('recentAnalysesList');
            
            if (analyses.length === 0) {
                // Keep the empty state
                return;
            }
            
            // Create table structure
            container.innerHTML = `
                <table class="analysis-table">
                    <thead>
                        <tr>
                            <th>Date Completed</th>
                            <th>ASC Standard</th>
                            <th>Document Size</th>
                            <th>Files</th>
                            <th>Tier</th>
                            <th>Cost</th>
                        </tr>
                    </thead>
                    <tbody id="analysisTableBody">
                    </tbody>
                </table>
            `;
            
            const tbody = document.getElementById('analysisTableBody');
            analyses.forEach(analysis => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(analysis.created_at).toLocaleDateString()}</td>
                    <td>${analysis.asc_standard}</td>
                    <td>${analysis.words_count ? analysis.words_count.toLocaleString() + ' words' : 'N/A'}</td>
                    <td>${analysis.file_count || 0}</td>
                    <td>${analysis.tier_name || 'N/A'}</td>
                    <td>${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(analysis.cost)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Sidebar navigation functions
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.dashboard-section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Remove active class from all nav items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Add active class to corresponding nav item
            const targetNav = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (targetNav) {
                targetNav.classList.add('active');
            }
            
            // Load section-specific data
            console.log('Switching to section:', sectionName);
            if (sectionName === 'credits') {
                console.log('Loading credit packages for credits section...');
                loadCreditPackages();
            } else if (sectionName === 'history') {
                console.log('Loading analysis history for history section...');
                loadAnalysisHistory();
            }
            
            // Update URL hash
            window.location.hash = sectionName;
        }

        // Custom amount functionality
        function selectCustomAmount() {
            const customAmount = document.getElementById('customAmount').value;
            const amount = parseFloat(customAmount);
            
            if (!amount || amount < 95 || amount > 3000) {
                alert('Please enter an amount between $95 and $3,000');
                return;
            }
            
            selectPackage(amount);
        }

        // Update showCreditPurchase to work with new layout
        function showCreditPurchase() {
            showSection('credits');
        }

        // Profile update functionality
        async function updateProfile(firstName, lastName) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/user/update-profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Update UI with new names
                        document.getElementById('userName').textContent = firstName;
                        document.getElementById('userFirstName').textContent = firstName;
                        document.getElementById('userLastName').textContent = lastName;
                        
                        showEditProfileMessage('Profile updated successfully!', 'success');
                        
                        // Clear form
                        document.getElementById('editProfileForm').reset();
                    } else {
                        showEditProfileMessage(data.error || 'Failed to update profile', 'error');
                    }
                } else {
                    const errorData = await response.json();
                    showEditProfileMessage(errorData.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showEditProfileMessage('Network error. Please try again.', 'error');
            }
        }

        function showEditProfileMessage(message, type) {
            const container = document.getElementById('editProfileMessage');
            if (container) {
                container.innerHTML = `<div class="${type}-message">${message}</div>`;
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Profile form submission handler
        async function submitProfileUpdate(event) {
            event.preventDefault();
            
            const firstName = document.getElementById('editFirstName').value.trim();
            const lastName = document.getElementById('editLastName').value.trim();
            const button = document.getElementById('updateProfileButton');
            
            if (!firstName || !lastName) {
                showEditProfileMessage('Please enter both first and last name', 'error');
                return;
            }
            
            // Show loading state
            button.disabled = true;
            button.textContent = 'Updating...';
            
            try {
                await updateProfile(firstName, lastName);
            } finally {
                button.disabled = false;
                button.textContent = 'Update Name';
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            window.location.href = 'login.html';
        }
        
        // Password strength validation function
        function validatePasswordStrength(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };
            
            // Update visual indicators
            const lengthEl = document.getElementById('req-length');
            const uppercaseEl = document.getElementById('req-uppercase');
            const lowercaseEl = document.getElementById('req-lowercase');
            const numberEl = document.getElementById('req-number');
            const specialEl = document.getElementById('req-special');
            
            if (lengthEl) lengthEl.className = requirements.length ? 'valid' : '';
            if (uppercaseEl) uppercaseEl.className = requirements.uppercase ? 'valid' : '';
            if (lowercaseEl) lowercaseEl.className = requirements.lowercase ? 'valid' : '';
            if (numberEl) numberEl.className = requirements.number ? 'valid' : '';
            if (specialEl) specialEl.className = requirements.special ? 'valid' : '';
            
            return Object.values(requirements).every(req => req);
        }
        
        function showChangePasswordMessage(message, type) {
            const container = document.getElementById('changePasswordMessage');
            if (container) {
                container.innerHTML = `<div class="${type}-message">${message}</div>`;
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // Initialize change password functionality
        setTimeout(() => {
            // Real-time password validation
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', function(e) {
                    validatePasswordStrength(e.target.value);
                });
            }
            
            // Password confirmation validation
            const confirmPasswordInput = document.getElementById('confirmNewPassword');
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', function(e) {
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = e.target.value;
                    const feedback = document.getElementById('password-match');
                    
                    if (!feedback) return;
                    
                    if (confirmPassword === '') {
                        feedback.textContent = '';
                        feedback.className = 'password-feedback';
                    } else if (newPassword === confirmPassword) {
                        feedback.textContent = '‚úì Passwords match';
                        feedback.className = 'password-feedback valid';
                    } else {
                        feedback.textContent = '‚úó Passwords do not match';
                        feedback.className = 'password-feedback invalid';
                    }
                });
            }
            
            // Change password form submission
            const changePasswordForm = document.getElementById('changePasswordForm');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                    const submitButton = document.getElementById('changePasswordButton');
                    
                    // Validate passwords match
                    if (newPassword !== confirmNewPassword) {
                        showChangePasswordMessage('Passwords do not match', 'error');
                        return;
                    }
                    
                    // Validate password strength
                    if (!validatePasswordStrength(newPassword)) {
                        showChangePasswordMessage('Password does not meet the requirements', 'error');
                        return;
                    }
                    
                    // Show loading state
                    submitButton.disabled = true;
                    submitButton.textContent = 'Updating Password...';
                    
                    try {
                        const token = localStorage.getItem('authToken');
                        const response = await fetch('/api/change-password', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                current_password: currentPassword,
                                new_password: newPassword
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showChangePasswordMessage('Password has been updated successfully!', 'success');
                            // Clear form
                            changePasswordForm.reset();
                            // Clear password match feedback
                            const feedback = document.getElementById('password-match');
                            if (feedback) {
                                feedback.textContent = '';
                                feedback.className = 'password-feedback';
                            }
                        } else {
                            showChangePasswordMessage(result.error || 'Password change failed. Please try again.', 'error');
                        }
                        
                    } catch (error) {
                        console.error('Change password error:', error);
                        showChangePasswordMessage('Network error. Please check your connection and try again.', 'error');
                    } finally {
                        // Reset loading state
                        submitButton.disabled = false;
                        submitButton.textContent = 'Update Password';
                    }
                });
            }
        }, 100);
        
        // Stripe Payment Integration
        let stripe = null;
        let elements = null;
        let cardElement = null;
        let selectedAmount = 0;
        
        async function initializeStripe() {
            try {
                const response = await fetch('/api/stripe/config');
                const { publishable_key } = await response.json();
                stripe = Stripe(publishable_key);
                
                elements = stripe.elements({
                    appearance: {
                        theme: 'stripe',
                        variables: {
                            colorPrimary: '#667eea',
                            colorBackground: '#ffffff',
                            colorText: '#30313d',
                            colorDanger: '#df1b41',
                            fontFamily: 'Inter, system-ui, sans-serif',
                            spacingUnit: '2px',
                            borderRadius: '8px',
                        }
                    }
                });
                
                cardElement = elements.create('card');
                cardElement.on('change', ({error}) => {
                    const displayError = document.getElementById('card-errors');
                    if (error) {
                        displayError.textContent = error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
                
            } catch (error) {
                console.error('Failed to initialize Stripe:', error);
                showPaymentMessage('Failed to initialize payment system', 'error');
            }
        }
        
        
        
        async function selectPackage(amount) {
            selectedAmount = amount;
            
            document.getElementById('selectedPackageDisplay').innerHTML = `
                <div class="selected-package-info">
                    <h4>Selected Package: $${amount.toLocaleString()} Credits</h4>
                    <p>You will be charged $${amount.toLocaleString()} USD. Credits expire 12 months from purchase.</p>
                </div>
            `;
            
            document.getElementById('paymentFormContainer').style.display = 'block';
            
            // Initialize Stripe if not already done
            if (!stripe) {
                await initializeStripe();
            }
            
            // Mount card element (track our own mounted state)
            if (cardElement && !cardElement.isCardMounted) {
                try {
                    cardElement.mount('#card-element');
                    cardElement.isCardMounted = true;
                    console.log('Card element mounted successfully');
                } catch (error) {
                    console.error('Error mounting card element:', error);
                    showPaymentMessage('Failed to load payment form', 'error');
                }
            }
        }
        
        function cancelPayment() {
            document.getElementById('paymentFormContainer').style.display = 'none';
            document.getElementById('creditPurchaseSection').style.display = 'none';
            selectedAmount = 0;
        }
        
        async function handlePayment(event) {
            event.preventDefault();
            
            const submitButton = document.getElementById('submit-payment');
            const buttonText = document.getElementById('button-text');
            
            submitButton.disabled = true;
            buttonText.textContent = 'Processing...';
            
            try {
                // Create payment intent
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/stripe/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ amount: selectedAmount })
                });
                
                const { client_secret } = await response.json();
                
                if (!response.ok) {
                    throw new Error('Failed to create payment intent');
                }
                
                // Confirm payment with Stripe
                const {error} = await stripe.confirmCardPayment(client_secret, {
                    payment_method: {
                        card: cardElement
                    }
                });
                
                if (error) {
                    showPaymentMessage(error.message, 'error');
                } else {
                    showPaymentMessage('Payment successful! Updating your balance...', 'success');
                    
                    // Poll for balance update instead of blind reload
                    pollForBalanceUpdate(selectedAmount);
                }
                
            } catch (error) {
                console.error('Payment error:', error);
                showPaymentMessage('Payment failed. Please try again.', 'error');
            } finally {
                submitButton.disabled = false;
                buttonText.textContent = 'Complete Payment';
            }
        }
        
        function showPaymentMessage(message, type) {
            const container = document.getElementById('payment-messages');
            container.innerHTML = `<div class="${type}-message">${message}</div>`;
            container.scrollIntoView({ behavior: 'smooth' });
        }
        
        async function pollForBalanceUpdate(expectedAmount) {
            const originalBalance = Number(document.getElementById('creditsBalance').textContent.replace(/[^0-9.-]+/g, '')) || 0;
            const maxAttempts = 20; // Poll for up to 20 seconds
            let attempts = 0;
            
            const checkBalance = async () => {
                attempts++;
                try {
                    const token = localStorage.getItem('authToken');
                    const response = await fetch('/api/user/profile', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    
                    if (data.credits_balance > originalBalance) {
                        // Balance updated! Show success and refresh
                        showPaymentMessage(`Success! $${expectedAmount} credits added to your account!`, 'success');
                        
                        // Update the displayed balance immediately
                        const balance = parseFloat(data.credits_balance);
                        const fmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
                        document.getElementById('creditsBalance').textContent = fmt.format(balance);
                        
                        // Hide payment form and refresh dashboard
                        setTimeout(() => {
                            cancelPayment();
                            window.location.reload();
                        }, 2000);
                        return;
                    }
                    
                    if (attempts < maxAttempts) {
                        // Continue polling
                        setTimeout(checkBalance, 1000); // Check every second
                    } else {
                        // Timeout - show message but still refresh
                        showPaymentMessage('Payment processed! Refreshing dashboard...', 'success');
                        setTimeout(() => {
                            cancelPayment();
                            window.location.reload();
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error checking balance:', error);
                    if (attempts < maxAttempts) {
                        setTimeout(checkBalance, 1000);
                    }
                }
            };
            
            // Start polling after 1 second delay
            setTimeout(checkBalance, 1000);
        }
        
        // Initialize payment form handler
        setTimeout(() => {
            const paymentForm = document.getElementById('payment-form');
            if (paymentForm) {
                paymentForm.addEventListener('submit', handlePayment);
            }
        }, 100);
    </script>
</body>
</html>