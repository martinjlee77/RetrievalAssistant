<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - VeritasLogic.ai</title>
    <!-- Force cache refresh -->
    <meta name="description" content="Manage your VeritasLogic account, track your usage, and access your ASC analysis tools.">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container" id="dashboardContent" style="padding-top: 40px;">
        <!-- Loading state -->
        <div class="loading" id="loadingState">
            <p>Loading your dashboard...</p>
        </div>

        <!-- Inline Login Form -->
        <div id="loginSection" style="display: none;">
            <div class="login-form-container">
                <div class="login-form">
                    <h2>üîê Sign In to Your Dashboard</h2>
                    <p>Enter your registered business email address to access your account.</p>
                    
                    <div id="loginMessage"></div>
                    
                    <form id="dashboardLoginForm">
                        <div class="form-group">
                            <label for="loginEmail">Business Email Address</label>
                            <input type="email" id="loginEmail" name="email" placeholder="your.email@company.com" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="loginButton">
                            Sign In
                        </button>
                    </form>
                    
                    <div class="login-links">
                        <p>Don't have an account? <a href="signup.html">Create account with instant activation</a></p>
                        <p><a href="index.html">‚Üê Back to homepage</a></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main dashboard content -->
        <div id="mainContent" style="display: none;">
            <div class="dashboard-header">
                <div class="welcome-section">
                    <h1>Welcome back, <span id="userName">User</span>!</h1>
                    <p id="memberSince">Member since</p>
                </div>
                <div class="header-actions">
                    <a href="https://a45dfa8e-cff4-4d5e-842f-dc8d14b3b2d2-00-3khkzanf4tnm3.picard.replit.dev/" class="btn btn-primary" target="_blank">Launch Analysis Tool</a>
                    <button onclick="logout()" class="btn btn-secondary">Sign Out</button>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <!-- Credits & Usage Overview -->
                <div class="card">
                    <h2>üí≥ Account Overview</h2>
                    
                    <div id="freeAnalysesSection" class="free-analyses">
                        <div class="number" id="freeAnalysesCount">3</div>
                        <div class="label">Free Analyses Remaining</div>
                    </div>
                    
                    <div class="credits-display" id="creditsSection" style="display: none;">
                        <div class="number" id="creditsBalance">$0</div>
                        <div class="label">Paid Credits Available</div>
                    </div>
                    
                    <div class="usage-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalAnalyses">0</div>
                            <div class="stat-label">Total Analyses</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="thisMonth">0</div>
                            <div class="stat-label">This Month</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalSpent">$0</div>
                            <div class="stat-label">Total Spent</div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Analyses -->
                <div class="card">
                    <h2>üìä Recent Analyses</h2>
                    <div id="recentAnalysesList" class="recent-analyses">
                        <div class="empty-state">
                            <div>üìÑ</div>
                            <p>No analyses yet. Ready to get started?</p>
                            <a href="https://a45dfa8e-cff4-4d5e-842f-dc8d14b3b2d2-00-3khkzanf4tnm3.picard.replit.dev/" class="btn btn-primary" target="_blank">Start Your First Analysis</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Profile Section -->
            <div class="card profile-section">
                <h2>üë§ Profile Information</h2>
                <div class="profile-fields">
                    <div class="profile-field">
                        <span class="field-label">Email:</span>
                        <span class="field-value" id="userEmail">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="field-label">Company:</span>
                        <span class="field-value" id="userCompany">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="field-label">Member Since:</span>
                        <span class="field-value" id="memberSinceDate">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="field-label">Account Status:</span>
                        <span class="field-value" id="accountStatus">Active</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dashboard initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        async function initializeDashboard() {
            const token = localStorage.getItem('authToken');
            
            if (!token) {
                // No token - show login form
                showLoginForm();
                return;
            }
            
            // Have token - try to fetch user data
            try {
                const response = await fetch('https://a45dfa8e-cff4-4d5e-842f-dc8d14b3b2d2-00-3khkzanf4tnm3.picard.replit.dev:3000/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    showDashboard(userData);
                } else {
                    // Token invalid - clear and show login
                    localStorage.removeItem('authToken');
                    showLoginForm();
                }
            } catch (error) {
                console.error('Network error:', error);
                showNetworkError();
            }
        }

        function showLoginForm() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
        }

        function showDashboard(userData) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            populateDashboard(userData);
        }

        function showNetworkError() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginSection').style.display = 'none';
            
            const errorContainer = document.createElement('div');
            errorContainer.className = 'network-error-container';
            errorContainer.innerHTML = `
                <div class="network-error">
                    <h2>‚ö†Ô∏è Connection Error</h2>
                    <p>Unable to connect to the server. Please check your internet connection and try again.</p>
                    <button onclick="retryConnection()" class="btn btn-primary">Try Again</button>
                </div>
            `;
            document.getElementById('dashboardContent').appendChild(errorContainer);
        }

        function retryConnection() {
            const errorContainers = document.querySelectorAll('.network-error-container');
            errorContainers.forEach(container => container.remove());
            document.getElementById('loadingState').style.display = 'flex';
            initializeDashboard();
        }

        // Handle login form submission
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('dashboardLoginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const loginButton = document.getElementById('loginButton');
            const messageContainer = document.getElementById('loginMessage');
            
            if (!email) {
                showLoginMessage('Please enter your email address', 'error');
                return;
            }
            
            // Show loading state
            loginButton.disabled = true;
            loginButton.textContent = 'Signing In...';
            messageContainer.innerHTML = '';
            
            try {
                const response = await fetch('https://a45dfa8e-cff4-4d5e-842f-dc8d14b3b2d2-00-3khkzanf4tnm3.picard.replit.dev:3000/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Store auth token
                    localStorage.setItem('authToken', data.token);
                    
                    // Show success message briefly
                    showLoginMessage('Login successful! Loading dashboard...', 'success');
                    
                    // Load dashboard after short delay
                    setTimeout(() => {
                        showDashboard(data.user);
                    }, 1000);
                    
                } else {
                    const errorData = await response.json();
                    showLoginMessage(errorData.error || 'Login failed. Please try again.', 'error');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showLoginMessage('Network error. Please check your connection and try again.', 'error');
            } finally {
                // Reset loading state
                loginButton.disabled = false;
                loginButton.textContent = 'Sign In';
            }
        }

        function showLoginMessage(message, type) {
            const container = document.getElementById('loginMessage');
            container.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        function populateDashboard(userData) {
            // Update welcome section
            document.getElementById('userName').textContent = userData.firstName || 'User';
            document.getElementById('memberSince').textContent = `Member since ${new Date(userData.createdAt).toLocaleDateString()}`;
            
            // Update profile information
            document.getElementById('userEmail').textContent = userData.email || '-';
            document.getElementById('userCompany').textContent = userData.company || '-';
            document.getElementById('memberSinceDate').textContent = new Date(userData.createdAt).toLocaleDateString() || '-';
            
            // Update credits and usage
            const freeAnalyses = userData.freeAnalysesRemaining || 0;
            const paidCredits = userData.credits || 0;
            
            document.getElementById('freeAnalysesCount').textContent = freeAnalyses;
            
            if (paidCredits > 0) {
                document.getElementById('creditsSection').style.display = 'block';
                document.getElementById('creditsBalance').textContent = `$${paidCredits.toFixed(2)}`;
            }
            
            // Update usage statistics
            document.getElementById('totalAnalyses').textContent = userData.totalAnalyses || 0;
            document.getElementById('thisMonth').textContent = userData.analysesThisMonth || 0;
            document.getElementById('totalSpent').textContent = `$${(userData.totalSpent || 0).toFixed(2)}`;
            
            // Load recent analyses
            loadRecentAnalyses(userData.recentAnalyses || []);
        }

        function loadRecentAnalyses(analyses) {
            const container = document.getElementById('recentAnalysesList');
            
            if (analyses.length === 0) {
                // Keep the empty state
                return;
            }
            
            container.innerHTML = '';
            analyses.forEach(analysis => {
                const item = document.createElement('div');
                item.className = 'analysis-item';
                item.innerHTML = `
                    <div class="analysis-details">
                        <h4>${analysis.title}</h4>
                        <p>${analysis.asc_standard} ‚Ä¢ ${new Date(analysis.created_at).toLocaleDateString()} ‚Ä¢ $${analysis.cost}</p>
                    </div>
                    <a href="${analysis.download_url}" class="btn btn-secondary" target="_blank">Download</a>
                `;
                container.appendChild(item);
            });
        }

        function logout() {
            localStorage.removeItem('authToken');
            showLoginForm();
        }
    </script>
</body>
</html>