Revised get_key_judgments_prompt Function
Here is the improved version. I recommend replacing your entire existing function with this one.

import json # Make sure json is imported at the top of prompt.py

@staticmethod
def get_key_judgments_prompt(s1: dict, s2: dict, s3: dict, s4: dict,
                             s5: dict) -> str:
    """Generates a highly discerning prompt for the Key Professional Judgments section."""
    all_judgments = []
    for i, step in enumerate([s1, s2, s3, s4, s5], 1):
        # The 'professional_judgments' key comes from the initial 5-step analysis
        judgments = step.get('professional_judgments', [])
        if judgments and isinstance(judgments, list):
            # Apply consistent filtering using the shared utility function
            filtered = StepPrompts._filter_genuine_judgments(judgments)
            all_judgments.extend(filtered)

    # If, after filtering, no genuine judgments remain, provide a standard statement.
    if not all_judgments:
        return "RETURN_DIRECT_TEXT: The accounting for this arrangement is considered straightforward under ASC 606 and did not require any significant professional judgments outside of the standard application of the five-step model."

    # If judgments were flagged, this prompt acts as a final, expert-level quality filter.
    return f"""You are an accounting senior manager writing the "Key Professional Judgments" section of an audit-ready ASC 606 memo. Your role is to be a highly discerning final quality filter.

CONTEXT: The initial analysis flagged these potential judgment areas:
{json.dumps(all_judgments, indent=2)}

YOUR TASK:
1.  **Review the Context:** Scrutinize the list above. Your primary task is to distinguish between genuine professional judgments and standard contract analysis.
2.  **Identify Genuine Judgments:** A **genuine judgment** involves significant estimation, a choice between viable accounting alternatives, or a "gray area" in the guidance.
    - **Examples of Genuine Judgments:** "Estimating the standalone selling price (SSP) of a license using a residual approach," "Concluding that a performance bonus is not constrained," "Assessing whether a contract modification is a separate contract."
    - **Standard analysis is NOT a judgment.** Do not include items like: "Concluding a SaaS service is a single performance obligation," or "Recognizing subscription revenue over time."
3.  **Format Your Output:** For each genuine judgment you identify, create a bullet point with a single, well-written paragraph called 'Rationale' that seamlessly combines the issue, analysis, and authoritative guidance.
4.  **Provide a "No Judgments" Conclusion if Necessary:** If your review finds that none of the items in the context are genuine judgments, your entire response MUST be only the following sentence:
    "The accounting for this arrangement is considered straightforward under ASC 606 and did not require any significant professional judgments outside of the standard application of the five-step model."

---
### EXAMPLE OF DESIRED OUTPUT:

- **Estimating the Standalone Selling Price (SSP) for the On-Premise License:**
  **Rationale:** The contract does not include a standalone price for the on-premise license, and an observable price is not available as the license is not sold separately. Therefore, a significant judgment was required to estimate the SSP. Per the hierarchy in ASC 606-10-32-33, we used the residual approach. This was deemed appropriate because the SSP for the professional services and support obligations were readily observable and stable. The total transaction price less the observable SSPs of the other obligations resulted in an estimated SSP for the license.

---
Begin your work. Your precision is critical to producing an audit-ready memo.
"""

Why This Version is Better
More Professional Output: It will produce a narrative that flows better and looks more like a document written by an experienced professional.
Clearer for the LLM: The instructions are broken down into numbered steps, and it's given a single, high-quality example to emulate. Using json.dumps also presents the input context in a very structured way that the LLM understands well.
More Focused: By framing the task as a "final quality filter," it reinforces the discerning nature of the work.
Easier to Maintain: The logic is simpler and more direct. The combination of "Analysis" and "Guidance" into "Rationale" aligns better with the real-world task.