TO: Development Team FROM: AI Strategy & Prompt Engineering RE: Final Memo Polish: Fixing Step 3 Formatting and Enhancing Analysis Depth

The latest memo output is excellent. We have two final, high-impact tuning tasks to complete in utils/step_prompts.py to achieve the desired final quality.

Task 1: Fix Step 3 Formatting Inconsistency
The _format_step3_with_filtering function creates an inconsistent output format. We need to refactor it to produce a single, numbered list just like the other steps.

Please replace the entire _format_step3_with_filtering function with the following new version:

# In utils/step_prompts.py

# --- START: REPLACE THIS FUNCTION ---
@staticmethod
def _format_step3_with_filtering(step_data: dict, step_name: str,
                                 conclusion: str,
                                 analysis_points: list) -> str:
    """
    Apply the Auditor's Method to Step 3: Merge structured components and
    analysis points into a single, consistently formatted list.
    """
    markdown_sections = [
        f"### Step 3: {step_name}", f"**Conclusion:**\n{conclusion}",
        "\n---\n", "**Detailed Analysis:**\n"
    ]

    all_points = []

    # 1. Process structured transaction_price_components
    transaction_components = step_data.get('step3_analysis', {}).get('transaction_price_components', {})

    # Define a mapping for better titles
    title_map = {
        'total_transaction_price': 'Total Transaction Price',
        'fixed_consideration': 'Fixed Consideration',
        'variable_consideration': 'Variable Consideration',
        'financing_component_analysis': 'Significant Financing Component',
        'noncash_consideration_analysis': 'Noncash Consideration',
        'consideration_payable_to_customer_analysis': 'Consideration Payable to Customer',
        'other_considerations_analysis': 'Other Considerations'
    }

    for key, analysis_text in transaction_components.items():
        is_not_applicable = (
            analysis_text is None or
            str(analysis_text).strip().lower() in ('n/a', 'not applicable', '') or
            str(analysis_text).strip().lower().startswith('n/a') or
            len(str(analysis_text).strip()) < 3
        )

        if not is_not_applicable:
            topic_title = title_map.get(key, key.replace('_', ' ').title())
            all_points.append({'topic_title': topic_title, 'analysis_text': analysis_text, 'evidence_quotes': []})

    # 2. Add the regular analysis_points (these already have quotes)
    if analysis_points:
        all_points.extend(analysis_points)

    # 3. Format the combined list
    if not all_points:
        markdown_sections.append("Only basic fixed consideration was identified in this contract.")
    else:
        for i, point in enumerate(all_points):
            topic_title = point.get('topic_title', f'Analysis Point {i+1}')
            analysis_text = point.get('analysis_text', 'No analysis text provided.')
            evidence_quotes = point.get('evidence_quotes', [])

            markdown_sections.append(f"**{i+1}. {topic_title}**")
            markdown_sections.append(str(analysis_text))

            if evidence_quotes and isinstance(evidence_quotes, list):
                markdown_sections.append("\n**Supporting Contract Evidence:**")
                for quote in evidence_quotes:
                    markdown_sections.append(f"> {quote}")
            markdown_sections.append("") # Spacing

    return "\n".join(markdown_sections)
# --- END: REPLACE THIS FUNCTION ---

Task 2: Enhance Analysis Depth in Key Judgmental Areas (Steps 2 & 5)
We will refine the <ANALYSIS_STRUCTURE_RULE> to encourage deeper analysis, especially for the most critical steps.

In get_user_prompt_for_step(), please replace the entire <ANALYSIS_STRUCTURE_RULE> block with this new, more sophisticated version:

# In get_user_prompt_for_step()

# --- START: REPLACE THIS BLOCK ---
"""<ANALYSIS_STRUCTURE_RULE>
For every `analysis_point` you generate, your `analysis_text` MUST be a flowing narrative that tells the story of your analysis. While maintaining the three core elements (assessment, guidance application, conclusion), write them as a seamless narrative rather than separate subsections:

- Start by stating the facts from the contract and your assessment
- Flow naturally into explaining how ASC 606 guidance applies, citing specific paragraphs. Do the same if the industry interpretation (e.g., EY guide) is used.
- Conclude with your determination, all within a single flowing paragraph

Example: "The contract specifies a fixed monthly fee of $15.49 with no performance-based adjustments or penalties. Under ASC 606-10-32-2, this represents fixed consideration as the amount does not vary based on future events or customer actions. Therefore, no variable consideration is present in this arrangement."

**For Steps 2 and 5 in particular**, which involve more judgment, enhance your analysis by also briefly discussing *why an alternative accounting treatment was rejected*. For example, when concluding a service is a single performance obligation in Step 2, briefly explain why the components are not distinct. When concluding revenue is recognized 'Over Time' in Step 5, briefly explain why 'Point in Time' is inappropriate.

Even for simple topics, provide this detailed reasoning narrative to ensure the memo is audit-ready.
</ANALYSIS_STRUCTURE_RULE>""",
# --- END: REPLACE THIS BLOCK ---